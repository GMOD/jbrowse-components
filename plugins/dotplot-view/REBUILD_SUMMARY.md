# Dotplot WebGL Rendering System - Complete Rebuild (2026-02-06)

## Overview
Completely rebuilt the dotplot gridlines, axes, and rendering system from scratch with a focus on clarity, correctness, and debuggability.

## Problem Statement
Previous implementation had fundamental issues:
1. **Scroll offset not applied**: Lines rendered out of bounds and didn't scroll correctly
2. **Coordinate transformation confusion**: Multiple coordinate spaces were being mixed up
3. **Complex layout system**: Difficult to debug and reason about
4. **Missing axes/gridlines**: No reference grid to understand coordinate system

## Solution

### 1. Fixed Coordinate Transformation (drawDotplotWebGL.ts)
**Before**: Shader only normalized pixel coordinates, no scroll offset applied
```glsl
// OLD: Lines would render at absolute positions, not relative to viewport
float x = (a_position.x / u_viewSize.x) * 2.0 - 1.0;
```

**After**: Shader applies scroll offset before normalization
```glsl
// NEW: Subtract offset to get viewport-relative position before normalization
vec2 relativePos = a_position - u_offset;
float x = (relativePos.x / u_viewSize.x) * 2.0 - 1.0;
```

### 2. New Axes & Gridlines Layer (DotplotAxesCanvas.tsx)
Created a separate 2D canvas overlay that:
- Renders gridlines at chromosome boundaries
- Displays axis labels
- Properly positioned within the bordered area
- Updates reactively with zoom/pan

### 3. Clear Layout Architecture (DotplotDisplay.tsx)
Two-layer rendering:
1. **WebGL Layer**: Data visualization (alignment segments as lines)
2. **Axes Layer**: Reference grid and labels

Both positioned absolutely within the view borders for pixel-perfect alignment.

### 4. Comprehensive Logging
Added detailed logging at each stage:
- **RPC (executeDotplotWebGLGeometry.ts)**: Logs input/output coordinates
- **Main Thread (afterAttach.ts)**: Logs render parameters and view state
- **WebGL Renderer (drawDotplotWebGL.ts)**: Logs geometry build and render calls
- **Canvas (DotplotWebGLCanvas.tsx)**: Logs initialization

## Files Changed/Created

### Modified Files
- **drawDotplotWebGL.ts**
  - Added `u_offset` uniform to vertex shader
  - Shader now applies offset before NDC conversion
  - Enhanced logging in buildGeometry and render
  - Better resource cleanup

- **DotplotDisplay.tsx**
  - Now combines WebGL canvas and axes canvas
  - Proper div wrapper with positioning

- **DotplotWebGLCanvas.tsx**
  - Positioned absolutely at (borderX, borderY)
  - Uses viewWidth/viewHeight for canvas size
  - Enhanced logging with dimension info

- **afterAttach.ts**
  - Updated to use viewWidth/viewHeight (not full width/height)
  - Enhanced logging with coordinate and view state info
  - Clearer variable naming

- **executeDotplotWebGLGeometry.ts** (RPC)
  - Added comprehensive logging of input and output
  - Logs first few features' coordinates for verification
  - Better error context in logs

### New Files
- **DotplotAxesCanvas.tsx**: 2D canvas overlay for gridlines and labels
- **COORDINATE_SYSTEM.md**: Comprehensive documentation of coordinate spaces and transformations
- **REBUILD_SUMMARY.md**: This file

## Coordinate System

### Three Coordinate Spaces
1. **View Space** (from RPC)
   - Absolute coordinates within the scrollable plot area
   - Generated by `bpToPx()` function
   - Y-inverted: `height - offsetPx` for target sequence

2. **Viewport Space** (in shader)
   - Coordinates relative to visible area
   - Calculated by subtracting scroll offset: `pos - u_offset`
   - Ranges from 0 to viewSize in visible area

3. **NDC Space** (WebGL)
   - Normalized device coordinates (-1 to 1)
   - Calculated from viewport coordinates

### Transformation Pipeline
```
RPC: genomic coords → view space coords (using bpToPx)
Main: view space coords → FeatPos objects
WebGL: vertex shader applies offset → viewport space → NDC → rendering
Axes: uses same offset system to position gridlines
```

## Testing Checklist

When running the application:
1. ✅ Check console logs for initialization
2. ✅ Verify features appear in the plot area
3. ✅ Check that gridlines are visible
4. ✅ Try zooming - gridlines should stay aligned
5. ✅ Try panning - features should move correctly
6. ✅ Check feature colors match expected scheme
7. ✅ Verify no rendering artifacts or out-of-bounds lines

## Key Improvements

| Issue | Before | After |
|-------|--------|-------|
| Scroll offset | Not applied | Applied in shader via `u_offset` uniform |
| Gridlines | Missing | 2D canvas overlay with proper positioning |
| Axes labels | Missing | Rendered on separate canvas layer |
| Logging | Minimal | Comprehensive at all stages |
| Layout clarity | Complex | Simple absolute positioning |
| Coordinate spaces | Confused | Clear documentation and implementation |

## Future Enhancements

Potential improvements for later:
1. Add interactive picking to identify features
2. Add color modes for CIGAR operations (I/D/X)
3. Add zoom-aware gridline density
4. Add axis scale labels (bp positions, not just refNames)
5. Add selection/highlight on hover
6. Add minimap for navigation
